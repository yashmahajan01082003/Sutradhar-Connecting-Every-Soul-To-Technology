<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sarthi</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;800&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet"/>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #07070d;
            --surface: #0e0e17;
            --surface2: #13131e;
            --surface3: #1a1a28;
            --border: rgba(255,255,255,0.06);
            --border2: rgba(255,255,255,0.10);
            --accent: #7c6aff;
            --accent2: #ff6ab0;
            --accent3: #6affcf;
            --text: #eeeef8;
            --text2: #b0b0c8;
            --muted: #52526a;
            --user-bg: rgba(124,106,255,0.10);
            --bot-bg: rgba(106,255,207,0.05);
            --sidebar-w: 260px;
        }

        html, body {
            height: 100%; width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'DM Mono', monospace;
            background: var(--bg);
            color: var(--text);
            display: flex;
        }

        /* â”€â”€ Animated BG mesh â”€â”€ */
        .bg-mesh {
            position: fixed; inset: 0;
            pointer-events: none; z-index: 0;
            overflow: hidden;
        }
        .bg-mesh span {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.18;
            animation: drift 14s ease-in-out infinite alternate;
        }
        .bg-mesh span:nth-child(1) {
            width: 600px; height: 600px;
            background: #7c6aff;
            top: -200px; left: -150px;
        }
        .bg-mesh span:nth-child(2) {
            width: 500px; height: 500px;
            background: #ff6ab0;
            bottom: -150px; right: -100px;
            animation-delay: -7s; animation-duration: 18s;
        }
        .bg-mesh span:nth-child(3) {
            width: 300px; height: 300px;
            background: #6affcf;
            top: 40%; left: 55%;
            animation-delay: -3s; animation-duration: 20s;
            opacity: 0.10;
        }
        @keyframes drift {
            from { transform: translate(0,0) scale(1); }
            to   { transform: translate(50px, 40px) scale(1.12); }
        }

        /* â”€â”€ Sidebar â”€â”€ */
        .sidebar {
            width: var(--sidebar-w);
            flex-shrink: 0;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }
        .sidebar-header {
            padding: 28px 20px 20px;
            border-bottom: 1px solid var(--border);
        }
        .brand {
            display: flex; align-items: center; gap: 12px;
        }
        .brand-icon {
            width: 38px; height: 38px;
            border-radius: 11px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            display: flex; align-items: center; justify-content: center;
            font-size: 17px;
            box-shadow: 0 0 20px rgba(124,106,255,0.45);
            flex-shrink: 0;
        }
        .brand-name {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 22px;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .brand-tag {
            font-size: 9px;
            color: var(--muted);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-top: 1px;
        }

        .new-chat-btn {
            margin: 16px 16px 0;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px dashed rgba(124,106,255,0.35);
            background: rgba(124,106,255,0.06);
            color: var(--accent);
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.2s;
            width: calc(100% - 32px);
        }
        .new-chat-btn:hover {
            background: rgba(124,106,255,0.14);
            border-color: var(--accent);
        }

        .sidebar-section-label {
            padding: 20px 20px 6px;
            font-size: 9px;
            color: var(--muted);
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
        }
        .status-pill {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--surface2);
            border: 1px solid var(--border);
        }
        .status-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--accent3);
            box-shadow: 0 0 8px var(--accent3);
            animation: pulse-dot 2.5s ease-in-out infinite;
            flex-shrink: 0;
        }
        @keyframes pulse-dot {
            0%,100% { opacity: 1; transform: scale(1); }
            50%      { opacity: 0.5; transform: scale(0.75); }
        }
        .status-text { font-size: 11px; color: var(--text2); }

        /* â”€â”€ Main chat area â”€â”€ */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            z-index: 10;
        }

        /* â”€â”€ Top bar â”€â”€ */
        .topbar {
            padding: 0 28px;
            height: 64px;
            border-bottom: 1px solid var(--border);
            background: rgba(14,14,23,0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }
        .back-btn {
            width: 34px; height: 34px;
            border-radius: 9px;
            border: 1px solid var(--border2);
            background: transparent;
            color: var(--muted);
            font-size: 15px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            text-decoration: none;
        }
        .back-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(124,106,255,0.08);
        }
        .topbar-title {
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 15px;
            flex: 1;
        }
        .topbar-actions { display: flex; gap: 8px; }

        /* â”€â”€ Language bar â”€â”€ */
        .lang-bar {
            padding: 8px 28px;
            border-bottom: 1px solid var(--border);
            background: rgba(14,14,23,0.6);
            display: flex;
            align-items: center;
            gap: 7px;
            flex-shrink: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .lang-bar::-webkit-scrollbar { display: none; }
        .lang-label {
            font-size: 9px;
            color: var(--muted);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            white-space: nowrap;
            margin-right: 4px;
        }
        .lang-chip {
            padding: 4px 11px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-family: 'DM Mono', monospace;
            font-size: 10.5px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .lang-chip:hover { border-color: var(--accent); color: var(--accent); }
        .lang-chip.active {
            background: rgba(124,106,255,0.14);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* â”€â”€ Messages â”€â”€ */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px 10% 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--border2) transparent;
        }
        .messages::-webkit-scrollbar { width: 4px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

        .msg {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slide-up 0.32s cubic-bezier(0.34,1.5,0.64,1) both;
            max-width: 820px;
        }
        .msg.user { flex-direction: row-reverse; margin-left: auto; }
        .msg.bot  { margin-right: auto; }

        @keyframes slide-up {
            from { opacity: 0; transform: translateY(18px) scale(0.97); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        .avatar {
            width: 34px; height: 34px;
            border-radius: 10px;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px;
        }
        .msg.user .avatar { background: linear-gradient(135deg, var(--accent), var(--accent2)); }
        .msg.bot  .avatar { background: linear-gradient(135deg, var(--accent3), var(--accent)); }

        .bubble {
            max-width: min(72ch, 80%);
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.7;
            border: 1px solid var(--border);
            position: relative;
            word-break: break-word;
        }
        .msg.user .bubble {
            background: var(--user-bg);
            border-color: rgba(124,106,255,0.22);
            border-bottom-right-radius: 3px;
        }
        .msg.bot .bubble {
            background: var(--bot-bg);
            border-color: rgba(106,255,207,0.10);
            border-bottom-left-radius: 3px;
        }
        .bubble-time {
            font-size: 9px;
            color: var(--muted);
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        /* â”€â”€ Markdown styles inside bubble â”€â”€ */
        .bubble h1, .bubble h2, .bubble h3 {
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            margin: 12px 0 5px;
            line-height: 1.3;
        }
        .bubble h1 { font-size: 17px; color: var(--text); }
        .bubble h2 { font-size: 15px; color: var(--accent); }
        .bubble h3 { font-size: 13.5px; color: var(--accent3); }
        .bubble strong { color: var(--text); font-weight: 600; }
        .bubble em { color: var(--accent2); font-style: italic; }
        .bubble code {
            background: rgba(255,255,255,0.07);
            border: 1px solid var(--border2);
            border-radius: 5px;
            padding: 1px 6px;
            font-size: 12.5px;
            font-family: 'DM Mono', monospace;
        }
        .bubble pre {
            background: rgba(0,0,0,0.45);
            border: 1px solid var(--border2);
            border-radius: 10px;
            padding: 12px 16px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 12.5px;
            line-height: 1.55;
        }
        .bubble pre code { background: none; border: none; padding: 0; }
        .bubble ul, .bubble ol { padding-left: 20px; margin: 6px 0; }
        .bubble li { margin: 4px 0; }
        .bubble hr { border: none; border-top: 1px solid var(--border2); margin: 12px 0; }
        .bubble p { margin: 5px 0; }
        .bubble a { color: var(--accent); text-decoration: underline; }

        /* â”€â”€ Typing indicator â”€â”€ */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 0 10%;
            margin-bottom: 4px;
        }
        .typing-indicator.visible { display: flex; }
        .typing-dots {
            display: flex; gap: 5px;
            padding: 13px 18px;
            background: var(--bot-bg);
            border: 1px solid rgba(106,255,207,0.10);
            border-radius: 16px;
            border-bottom-left-radius: 3px;
        }
        .typing-dots span {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--accent3);
            animation: bounce 1.2s ease-in-out infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%,60%,100% { transform: translateY(0); opacity: 0.35; }
            30%          { transform: translateY(-9px); opacity: 1; }
        }

        /* â”€â”€ Voice badge â”€â”€ */
        .voice-badge {
            display: none;
            align-items: center;
            gap: 7px;
            padding: 6px 14px;
            background: rgba(255,106,176,0.08);
            border: 1px solid rgba(255,106,176,0.22);
            border-radius: 8px;
            font-size: 11px;
            color: var(--accent2);
            margin: 0 28px 10px;
            flex-shrink: 0;
            width: fit-content;
        }
        .voice-badge.visible { display: flex; }
        .voice-badge-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--accent2);
            animation: pulse-dot 1s infinite;
        }

        /* â”€â”€ Input area â”€â”€ */
        .input-zone {
            padding: 16px 10%;
            border-top: 1px solid var(--border);
            background: rgba(14,14,23,0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            flex-shrink: 0;
        }
        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: var(--surface2);
            border: 1px solid var(--border2);
            border-radius: 16px;
            padding: 8px 10px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-row:focus-within {
            border-color: rgba(124,106,255,0.45);
            box-shadow: 0 0 0 3px rgba(124,106,255,0.07);
        }
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 13.5px;
            padding: 6px 8px;
            resize: none;
            outline: none;
            line-height: 1.55;
            max-height: 140px;
            min-height: 36px;
            overflow-y: auto;
            scrollbar-width: none;
        }
        textarea::placeholder { color: var(--muted); }

        .btn {
            width: 40px; height: 40px;
            border-radius: 11px;
            border: none;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .send-btn {
            background: linear-gradient(135deg, var(--accent), #5244f0);
            color: white;
            box-shadow: 0 4px 18px rgba(124,106,255,0.4);
        }
        .send-btn:hover { transform: scale(1.07); box-shadow: 0 6px 26px rgba(124,106,255,0.55); }
        .send-btn:active { transform: scale(0.95); }

        .mic-btn {
            background: transparent;
            border: 1px solid var(--border2);
            color: var(--muted);
        }
        .mic-btn:hover { border-color: var(--accent2); color: var(--accent2); background: rgba(255,106,176,0.06); }
        .mic-btn.recording {
            background: rgba(255,106,176,0.12);
            border-color: var(--accent2);
            color: var(--accent2);
            animation: mic-pulse 1.1s ease-in-out infinite;
        }
        @keyframes mic-pulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(255,106,176,0.5); }
            50%      { box-shadow: 0 0 0 9px rgba(255,106,176,0); }
        }

        .input-hint {
            text-align: center;
            font-size: 10px;
            color: var(--muted);
            margin-top: 8px;
            letter-spacing: 0.3px;
        }

        /* â”€â”€ Welcome screen â”€â”€ */
        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }
        .welcome-glow {
            width: 80px; height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            display: flex; align-items: center; justify-content: center;
            font-size: 34px;
            margin: 0 auto 24px;
            box-shadow: 0 0 60px rgba(124,106,255,0.4), 0 0 120px rgba(255,106,176,0.2);
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0%,100% { transform: translateY(0); }
            50%      { transform: translateY(-8px); }
        }
        .welcome-title {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 28px;
            color: var(--text);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .welcome-sub {
            font-size: 13px;
            line-height: 1.7;
            max-width: 360px;
            color: var(--text2);
        }
        .welcome-chips {
            display: flex; gap: 8px; flex-wrap: wrap;
            justify-content: center;
            margin-top: 28px;
        }
        .welcome-chip {
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid var(--border2);
            background: var(--surface2);
            color: var(--text2);
            font-family: 'DM Mono', monospace;
            font-size: 11.5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .welcome-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(124,106,255,0.08);
        }

        /* â”€â”€ Responsive: hide sidebar on small screens â”€â”€ */
        @media (max-width: 720px) {
            .sidebar { display: none; }
            .messages { padding: 20px 16px; }
            .input-zone { padding: 12px 16px; }
            .typing-indicator { padding: 0 16px; }
        }
    </style>
</head>
<body>

<!-- Animated bg -->
<div class="bg-mesh">
    <span></span><span></span><span></span>
</div>

<!-- Sidebar -->
<aside class="sidebar">
    <div class="sidebar-header">
        <div class="brand">
            <div class="brand-icon">âœ¦</div>
            <div>
                <div class="brand-name">Sarthi</div>
                <div class="brand-tag">Your AI Companion</div>
            </div>
        </div>
    </div>
    <button class="new-chat-btn" onclick="newChat()">ï¼‹ &nbsp;New Conversation</button>
    <div class="sidebar-section-label">Recent</div>

    <div class="sidebar-footer">
        <div class="status-pill">
            <div class="status-dot"></div>
            <span class="status-text">AI is online &amp; ready</span>
        </div>
    </div>
</aside>

<!-- Main -->
<div class="main">

    <!-- Top bar -->
    <div class="topbar">
        <a class="back-btn" href="javascript:history.back()" title="Go back">&#8592;</a>
        <div class="topbar-title">Conversation</div>
        <div class="topbar-actions">
            <!-- placeholder for future actions -->
        </div>
    </div>

    <!-- Language bar -->
    <div class="lang-bar">
        <span class="lang-label">ğŸ™ Voice Lang</span>
        <button class="lang-chip active" data-lang="en-US">EN</button>
        <button class="lang-chip" data-lang="hi-IN">à¤¹à¤¿à¤‚</button>
        <button class="lang-chip" data-lang="es-ES">ES</button>
        <button class="lang-chip" data-lang="fr-FR">FR</button>
        <button class="lang-chip" data-lang="de-DE">DE</button>
        <button class="lang-chip" data-lang="ja-JP">JP</button>
        <button class="lang-chip" data-lang="zh-CN">ä¸­</button>
        <button class="lang-chip" data-lang="ar-SA">AR</button>
        <button class="lang-chip" data-lang="pt-BR">PT</button>
        <button class="lang-chip" data-lang="ko-KR">KR</button>
    </div>

    <!-- Messages -->
    <div class="messages" id="messages">
        <div class="welcome" id="welcomeScreen">
            <div class="welcome-glow">âœ¦</div>
            <div class="welcome-title">Namaste! I'm Sarthi ğŸ™</div>
            <div class="welcome-sub">Ask me anything â€” I can help you learn, create, plan, and explore ideas in any language.</div>
            <div class="welcome-chips">
                <button class="welcome-chip" onclick="prefill('Explain quantum computing simply')">Explain quantum computing</button>
                <button class="welcome-chip" onclick="prefill('Write a poem about monsoon in Hindi')">Poem in Hindi ğŸŒ§</button>
                <button class="welcome-chip" onclick="prefill('Help me plan my week')">Plan my week ğŸ“…</button>
                <button class="welcome-chip" onclick="prefill('What is the meaning of life?')">Meaning of life ğŸ¤”</button>
            </div>
        </div>
    </div>

    <!-- Typing indicator -->
    <div class="typing-indicator" id="typingIndicator">
        <div style="width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#6affcf,#7c6aff);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;">âœ¦</div>
        <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>

    <!-- Voice badge -->
    <div class="voice-badge" id="voiceBadge">
        <div class="voice-badge-dot"></div>
        <span id="voiceBadgeText">Listeningâ€¦</span>
    </div>

    <!-- Input zone -->
    <div class="input-zone">
        <div class="input-row">
            <button class="btn mic-btn" id="micBtn" title="Voice input">ğŸ™ï¸</button>
            <textarea id="messageInput" placeholder="Message Sarthiâ€¦ (Enter to send, Shift+Enter for newline)" rows="1"></textarea>
            <button class="btn send-btn" id="sendBtn" title="Send">â¤</button>
        </div>
        <div class="input-hint">Sarthi may make mistakes. Verify important info.</div>
    </div>
</div>

{% csrf_token %}

<script>
// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCookie(name) {
    const match = document.cookie.split(';').map(c => c.trim())
        .find(c => c.startsWith(name + '='));
    return match ? decodeURIComponent(match.split('=')[1]) : null;
}

function formatTime() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function escapeHTML(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Quick-prompt prefill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function prefill(text) {
    inputEl.value = text;
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + 'px';
    inputEl.focus();
}

// â”€â”€ New chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newChat() {
    messagesEl.innerHTML = `
        <div class="welcome" id="welcomeScreen">
            <div class="welcome-glow">âœ¦</div>
            <div class="welcome-title">Namaste! I'm Sarthi ğŸ™</div>
            <div class="welcome-sub">Ask me anything â€” I can help you learn, create, plan, and explore ideas in any language.</div>
            <div class="welcome-chips">
                <button class="welcome-chip" onclick="prefill('Explain quantum computing simply')">Explain quantum computing</button>
                <button class="welcome-chip" onclick="prefill('Write a poem about monsoon in Hindi')">Poem in Hindi ğŸŒ§</button>
                <button class="welcome-chip" onclick="prefill('Help me plan my week')">Plan my week ğŸ“…</button>
                <button class="welcome-chip" onclick="prefill('What is the meaning of life?')">Meaning of life ğŸ¤”</button>
            </div>
        </div>`;
    inputEl.value = '';
    inputEl.style.height = '';
}

// â”€â”€ Markdown â†’ HTML formatter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatMarkdown(raw) {
    let t = escapeHTML(raw);

    // Code blocks (``` ... ```) â€” do before inline code
    t = t.replace(/```[\w]*\n?([\s\S]*?)```/g, (_, code) =>
        `<pre><code>${code.trim()}</code></pre>`);

    // Inline code
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');

    // Headings (### ## #)
    t = t.replace(/^### (.+)$/gm, '<h3>$1</h3>');
    t = t.replace(/^## (.+)$/gm,  '<h2>$1</h2>');
    t = t.replace(/^# (.+)$/gm,   '<h1>$1</h1>');

    // Bold (**text** or __text__)
    t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/__(.+?)__/g,     '<strong>$1</strong>');

    // Italic (*text* or _text_) â€” single star/underscore
    t = t.replace(/\*([^*\n]+?)\*/g, '<em>$1</em>');
    t = t.replace(/_([^_\n]+?)_/g,   '<em>$1</em>');

    // Horizontal rule
    t = t.replace(/^---+$/gm, '<hr>');

    // Unordered lists (* item or - item)
    t = t.replace(/^[\*\-] (.+)$/gm, '<li>$1</li>');
    t = t.replace(/(<li>[\s\S]*?<\/li>)/g, m => `<ul>${m}</ul>`);
    // Collapse consecutive </ul><ul>
    t = t.replace(/<\/ul>\s*<ul>/g, '');

    // Ordered lists (1. item)
    t = t.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

    // Line breaks â†’ <br> for plain lines (not inside block tags)
    t = t.replace(/(?<!>)\n(?!<)/g, '<br>');

    // Wrap lone text lines in <p> (simple pass â€” avoids double-wrapping)
    t = t.replace(/^(?!<[a-z])(.*\S.*)$/gm, '<p>$1</p>');

    return t;
}

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const messagesEl   = document.getElementById('messages');
const inputEl      = document.getElementById('messageInput');
const sendBtn      = document.getElementById('sendBtn');
const micBtn       = document.getElementById('micBtn');
const typingEl     = document.getElementById('typingIndicator');
const voiceBadge   = document.getElementById('voiceBadge');
const voiceBadgeTxt= document.getElementById('voiceBadgeText');
const langChips    = document.querySelectorAll('.lang-chip');

let selectedLang = 'en-US';

// â”€â”€ Language chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
langChips.forEach(chip => {
    chip.addEventListener('click', () => {
        langChips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        selectedLang = chip.dataset.lang;
    });
});

// â”€â”€ Auto-resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
});

inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
sendBtn.addEventListener('click', sendMessage);

// â”€â”€ Append message bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMsg(role, text) {
    const welcome = document.getElementById('welcomeScreen');
    if (welcome) welcome.remove();

    const isUser = role === 'user';
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    const content = isUser ? escapeHTML(text) : formatMarkdown(text);
    div.innerHTML = `
        <div class="avatar">${isUser ? 'ğŸ‘¤' : 'âœ¦'}</div>
        <div class="bubble">
            ${content}
            <div class="bubble-time">${formatTime()}</div>
        </div>`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    appendMsg('user', text);
    inputEl.value = '';
    inputEl.style.height = '';

    // Show typing
    typingEl.classList.add('visible');
    messagesEl.scrollTop = messagesEl.scrollHeight;

    fetch('/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: text })
    })
    .then(r => r.json())
    .then(data => {
        typingEl.classList.remove('visible');
        appendMsg('bot', data.response || data.error || 'Something went wrong.');
    })
    .catch(() => {
        typingEl.classList.remove('visible');
        appendMsg('bot', 'Server error occurred.');
    });
}

// â”€â”€ Voice input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isRecording = false;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = () => {
        isRecording = true;
        micBtn.classList.add('recording');
        voiceBadge.classList.add('visible');
        voiceBadgeTxt.textContent = 'Listeningâ€¦';
    };

    recognition.onresult = (e) => {
        let interim = '', final = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
            const t = e.results[i][0].transcript;
            if (e.results[i].isFinal) final += t;
            else interim += t;
        }
        voiceBadgeTxt.textContent = interim || final || 'Listeningâ€¦';
        if (final) inputEl.value = (inputEl.value + ' ' + final).trim();
    };

    recognition.onend = () => {
        isRecording = false;
        micBtn.classList.remove('recording');
        voiceBadge.classList.remove('visible');
        // Resize textarea
        inputEl.style.height = 'auto';
        inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
    };

    recognition.onerror = (e) => {
        isRecording = false;
        micBtn.classList.remove('recording');
        voiceBadge.classList.remove('visible');
        voiceBadgeTxt.textContent = 'Error: ' + e.error;
    };

    micBtn.addEventListener('click', () => {
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.lang = selectedLang;
            recognition.start();
        }
    });
} else {
    micBtn.title = 'Speech recognition not supported in this browser';
    micBtn.style.opacity = '0.4';
    micBtn.style.cursor = 'not-allowed';
}
</script>
</body>
</html>